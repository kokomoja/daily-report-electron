

<!doctype html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>Login</title>
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self'"
    />
    <style>
      body {
        font-family: sans-serif;
        margin: 50px;
        text-align: center;
      }
      input {
        display: block;
        margin: 10px auto;
        padding: 5px;
        width: 200px;
      }
      button {
        margin-top: 10px;
        padding: 5px 15px;
      }
    </style>
  </head>
  <body>
    <h2>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
    <input type="text" id="login_user" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" />
    <input type="password" id="login_password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" />
    <button id="loginBtn">Login</button>

    <script>
      window.addEventListener("DOMContentLoaded", () => {
        const loginBtn = document.getElementById("loginBtn");

        loginBtn.addEventListener("click", async () => {
          const user = document.getElementById("login_user").value;
          const pass = document.getElementById("login_password").value;

          if (!user || !pass) {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô");
            return;
          }

          const res = await window.auth.login({ user, pass });

          if (res.success) {
            console.log("‚úÖ Login ‡∏ú‡πà‡∏≤‡∏ô");
            // ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ main
            window.location = "index.html";
          } else {
            alert("‚ùå " + (res.message || res.error));
          }
        });
      });
    </script>
  </body>
</html>


<!doctype html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>Daily Report</title>
    <style>
      table {
        border-collapse: collapse;
        width: 100%;
      }
      table,
      th,
      td {
        border: 1px solid black;
      }
      th,
      td {
        text-align: center;
        vertical-align: middle;
        padding: 5px;
      }
      #exportBtn {
        margin-left: 10px;
      }
    </style>
  </head>
  <body>
    <h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô ‡∏ù‡πà‡∏≤‡∏¢‡∏õ‡∏é‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏Å‡∏≠‡∏á</h2>
    <p id="welcome"></p>
    <label>ID:</label>
    <input type="text" id="op_id" disabled /><br /><br />

    <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
    <input type="date" id="op_date" /><br /><br />

    <label>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£:</label>
    <select id="machine"></select
    ><br /><br />

    <label>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</label>
    <select id="operator"></select
    ><br /><br />

    <label>‡∏á‡∏≤‡∏ô:</label>
    <input type="text" id="job" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥..." /><br /><br />

    <label>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:</label>
    <input type="datetime-local" id="start_time" /><br /><br />

    <label>‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</label>
    <input type="datetime-local" id="stop_time" /><br /><br />

    <button id="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    <button id="clearBtn">‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå</button>
    <button id="exportBtn">Export to Excel</button>
    <button id="exportPdfBtn">Export to PDF</button>

    <h3 id="reportTitle">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
    <table id="reportTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
          <th>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</th>
          <th>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
          <th>‡∏á‡∏≤‡∏ô</th>
          <th>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</th>
          <th>‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</th>
          <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
          <th>
            <button id="deleteBtn" onclick="deleteSelected()">
              ‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            </button>
            <br />
            <input type="checkbox" id="checkAll" /> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
          </th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <script>
      function formatThaiDate(dateStr) {
        if (!dateStr) return "";
        const d = new Date(dateStr);
        const thaiMonths = [
          "‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°",
          "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå",
          "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°",
          "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô",
          "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°",
          "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô",
          "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°",
          "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°",
          "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô",
          "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°",
          "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô",
          "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°",
        ];
        const day = d.getDate();
        const month = thaiMonths[d.getMonth()];
        const year = d.getFullYear() + 543; // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡∏û.‡∏®.
        return `${day} ${month} ${year}`;
      }

      function updateReportTitle() {
        const selectedDate = document.getElementById("op_date").value;
        const title = selectedDate
          ? `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatThaiDate(selectedDate)}`
          : "‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";
        document.getElementById("reportTitle").textContent = title;
      }

      function formatDate(dateValue) {
        if (!dateValue) return "";
        if (dateValue instanceof Date) {
          const yyyy = dateValue.getUTCFullYear();
          const mm = String(dateValue.getUTCMonth() + 1).padStart(2, "0");
          const dd = String(dateValue.getUTCDate()).padStart(2, "0");
          return `${yyyy}-${mm}-${dd}`;
        }
        return dateValue.toString().slice(0, 10);
      }

      function formatDateTime(dateValue) {
        if (!dateValue) return "";
        if (dateValue instanceof Date) {
          const yyyy = dateValue.getUTCFullYear();
          const mm = String(dateValue.getUTCMonth() + 1).padStart(2, "0");
          const dd = String(dateValue.getUTCDate()).padStart(2, "0");
          const hh = String(dateValue.getUTCHours()).padStart(2, "0");
          const min = String(dateValue.getUTCMinutes()).padStart(2, "0");
          return `${yyyy}-${mm}-${dd} ${hh}:${min}`;
        }
        return dateValue.toString().replace("T", " ").slice(0, 16);
      }

      function formatHourMinute(totalMinutes) {
        if (totalMinutes == null) return "";
        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;
        return `${hours.toString().padStart(2, "0")}:${minutes
          .toString()
          .padStart(2, "0")}`;
      }

      function getDefaultDateTime(hour, minute) {
        const now = new Date();
        now.setHours(hour, minute, 0, 0);
        return now.toISOString().slice(0, 16);
      }

      // ‚úÖ clear form (reset ‡∏Ñ‡πà‡∏≤ default)
      function clearForm() {
        const today = document.getElementById("op_date").value;
        document.getElementById("op_id").value = "";
        document.getElementById("machine").value = "";
        document.getElementById("operator").value = "";
        document.getElementById("job").value = "";
        document.getElementById("start_time").value = `${today}T08:00`;
        document.getElementById("stop_time").value = `${today}T17:00`;
        document.getElementById("submit").textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å";
      }

      // ======================= Load Lists =======================
      async function loadLists() {
        const lists = await window.api.getLists();
        const machineSelect = document.getElementById("machine");
        const operatorSelect = document.getElementById("operator");

        machineSelect.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ --</option>`;
        operatorSelect.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô --</option>`;

        if (lists.machines) {
          // ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô
          lists.machines
            .sort((a, b) => a.localeCompare(b, "th")) // th ‚Üí ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏ö‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏î‡πâ‡∏ß‡∏¢
            .forEach(
              (m) =>
                (machineSelect.innerHTML += `<option value="${m}">${m}</option>`)
            );
        }

        if (lists.operators) {
          // ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô
          lists.operators
            .sort((a, b) => a.localeCompare(b, "th"))
            .forEach(
              (o) =>
                (operatorSelect.innerHTML += `<option value="${o}">${o}</option>`)
            );
        }
      }

      // ======================= Load Reports =======================
      async function loadReports() {
        const selectedDate = document.getElementById("op_date").value;
        const reports = await window.api.getReports(selectedDate);
        const tbody = document.querySelector("#reportTable tbody");
        tbody.innerHTML = "";

        if (reports && !reports.error) {
          reports.forEach((r) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${r.op_id}</td>
              <td>${formatDate(r.op_date)}</td>
              <td>${r.machine || ""}</td>
              <td>${r.operator || ""}</td>
              <td>${r.job || ""}</td>
              <td>${formatDateTime(r.start_time)}</td>
              <td>${formatDateTime(r.stop_time)}</td>
              <td>${formatHourMinute(r.op_hour)}</td>
              <td><input type="checkbox" class="rowCheck" value="${r.op_id}"></td>
            `;
            tr.addEventListener("click", () => {
              document.getElementById("op_id").value = r.op_id;
              document.getElementById("op_date").value = formatDate(r.op_date);
              document.getElementById("machine").value = r.machine || "";
              document.getElementById("operator").value = r.operator || "";
              document.getElementById("job").value = r.job || "";
              if (r.start_time)
                document.getElementById("start_time").value = new Date(
                  r.start_time
                )
                  .toISOString()
                  .slice(0, 16);
              if (r.stop_time)
                document.getElementById("stop_time").value = new Date(
                  r.stop_time
                )
                  .toISOString()
                  .slice(0, 16);
              document.getElementById("submit").textContent = "‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó";
            });
            tbody.appendChild(tr);
          });
        }

        document
          .getElementById("checkAll")
          .addEventListener("change", function () {
            document
              .querySelectorAll(".rowCheck")
              .forEach((cb) => (cb.checked = this.checked));
          });
      }

      // ======================= Delete =======================
      async function deleteSelected() {
        const checked = Array.from(
          document.querySelectorAll(".rowCheck:checked")
        ).map((cb) => parseInt(cb.value));
        if (checked.length === 0) {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö");
          return;
        }
        if (confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö ${checked.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?`)) {
          const res = await window.api.deleteMultiple(checked);
          alert(res.message || res.error);
          await loadReports();

          // ‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏•‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
          clearForm();
        }
      }

      // ======================= Export =======================
      async function exportExcel() {
        const selectedDate = document.getElementById("op_date").value;
        const res = await window.api.exportExcel(selectedDate);
        if (res.success) alert("‚úÖ " + res.message + "\n‡πÑ‡∏ü‡∏•‡πå: " + res.path);
        else alert("‚ùå Export ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: " + res.error);
      }

      async function exportPDF() {
        const selectedDate = document.getElementById("op_date").value;
        const res = await window.api.exportPDF(selectedDate);
        if (res.success) alert("‚úÖ " + res.message + "\n‡πÑ‡∏ü‡∏•‡πå: " + res.path);
        else alert("‚ùå Export PDF ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: " + res.error);
      }

      // ======================= Init =======================
      window.addEventListener("DOMContentLoaded", () => {
        document.getElementById("op_date").value = new Date()
          .toISOString()
          .split("T")[0];
        updateReportTitle();
        document.getElementById("start_time").value = getDefaultDateTime(8, 0);
        document.getElementById("stop_time").value = getDefaultDateTime(17, 0);

        document
          .getElementById("submit")
          .addEventListener("click", async () => {
            const data = {
              op_id: document.getElementById("op_id").value || null,
              op_date: document.getElementById("op_date").value,
              machine: document.getElementById("machine").value,
              operator: document.getElementById("operator").value,
              job: document.getElementById("job").value,
              start_time: document.getElementById("start_time").value,
              stop_time: document.getElementById("stop_time").value,
            };
            const res = data.op_id
              ? await window.api.updateReport(data)
              : await window.api.saveReport(data);
            alert(res.message || res.error);
            await loadReports();
            clearForm();
          });

        document.getElementById("clearBtn").addEventListener("click", () => {
          clearForm();
        });

        document.getElementById("op_date").addEventListener("change", () => {
          updateReportTitle();
          clearForm();
          loadReports();
        });

        document
          .getElementById("exportBtn")
          .addEventListener("click", exportExcel);
        document
          .getElementById("exportPdfBtn")
          .addEventListener("click", exportPDF);

        loadLists();
        loadReports();
      });

      window.addEventListener("login-success", (e) => {
        const user = e.detail;
        document.getElementById("welcome").textContent =
          "üëã ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì " + user.username;
      });
    </script>
  </body>
</html>

// main.js
const { app, BrowserWindow, ipcMain } = require("electron");
const path = require("path");
const sql = require("mssql");
const XLSX = require("xlsx");
const PDFDocument = require("pdfkit");
const fs = require("fs");

// Config SQL Server
const config = {
  server: "192.168.7.110",
  database: "opDb",
  user: "sa",
  password: "123456",
  options: {
    encrypt: false,
    trustServerCertificate: true,
    instanceName: "sqlexpress",
  },
};

app.commandLine.appendSwitch("disable-gpu-shader-disk-cache");

let mainWindow;

function createWindow(file) {
  mainWindow = new BrowserWindow({
    width: 1000,
    height: 700,
    webPreferences: {
      preload: path.join(__dirname, "preload.js"),
      contextIsolation: true,
      nodeIntegration: false,
    },
  });

  mainWindow.loadFile(path.join(__dirname, file));
}

app.on("ready", () => {
  createWindow("login.html");
});

function toLocalDateTime(dateStr) {
  if (!dateStr) return null;
  const d = new Date(dateStr);
  d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
  return d;
}

function formatDateUTC(dateValue) {
  if (!dateValue) return "";
  const d = new Date(dateValue);
  const yyyy = d.getUTCFullYear();
  const mm = String(d.getUTCMonth() + 1).padStart(2, "0");
  const dd = String(d.getUTCDate()).padStart(2, "0");
  return `${yyyy}-${mm}-${dd}`;
}

function formatDateTimeUTC(dateValue) {
  if (!dateValue) return "";
  const d = new Date(dateValue);
  const yyyy = d.getUTCFullYear();
  const mm = String(d.getUTCMonth() + 1).padStart(2, "0");
  const dd = String(d.getUTCDate()).padStart(2, "0");
  const hh = String(d.getUTCHours()).padStart(2, "0");
  const min = String(d.getUTCMinutes()).padStart(2, "0");
  return `${yyyy}-${mm}-${dd} ${hh}:${min}`;
}

function formatHourMinute(totalMinutes) {
  if (totalMinutes == null) return "";
  const hours = Math.floor(totalMinutes / 60);
  const minutes = totalMinutes % 60;
  return `${hours.toString().padStart(2, "0")}:${minutes.toString().padStart(2, "0")}`;
}

function getFontPath(fontFile) {
  if (fs.existsSync(path.join(__dirname, "fonts", fontFile))) {
    return path.join(__dirname, "fonts", fontFile); // dev mode
  }
  return path.join(process.resourcesPath, "fonts", fontFile); // build exe
}

// ====================== HANDLERS ======================
ipcMain.handle("login-check", async (event, data) => {
  try {
    const pool = await sql.connect(config);
    const result = await pool
      .request()
      .input("user", sql.VarChar(50), data.user)
      .input("pass", sql.VarChar(50), data.pass)
      .query(
        "SELECT * FROM loginID WHERE login_user=@user AND login_password=@pass"
      );

    if (result.recordset.length > 0) {
      return { success: true, message: "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" };
    } else {
      return { success: false, message: "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á" };
    }
  } catch (err) {
    return { success: false, error: err.message };
  }
});

ipcMain.handle("add-user", async (event, data) => {
  try {
    if (data.secret !== "0845535000721") {
      return { success: false, message: "‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á" };
    }

    const pool = await sql.connect(config);
    await pool
      .request()
      .input("login_user", sql.VarChar(50), data.login_user)
      .input("login_password", sql.VarChar(50), data.login_password)
      .input("username", sql.VarChar(50), data.username)
      .query(
        "INSERT INTO loginID (login_user, login_password, usernam) VALUES (@login_user, @login_password, @username)"
      );

    return { success: true, message: "‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" };
  } catch (err) {
    return { success: false, error: err.message };
  }
});

ipcMain.handle("get-lists", async () => {
  try {
    let pool = await sql.connect(config);
    const machines = await pool
      .request()
      .query("SELECT machine FROM machineNumber");
    const operators = await pool
      .request()
      .query("SELECT op_name FROM operatorName");
    return {
      machines: machines.recordset.map((m) => m.machine),
      operators: operators.recordset.map((o) => o.op_name),
    };
  } catch (err) {
    console.error("get-lists error:", err);
    return { error: err.message };
  }
});

ipcMain.handle("insert-report", async (event, data) => {
  try {
    let pool = await sql.connect(config);
    await pool
      .request()
      .input("op_date", sql.Date, data.op_date)
      .input("machine", sql.VarChar(50), data.machine)
      .input("operator", sql.VarChar(50), data.operator)
      .input("job", sql.VarChar(100), data.job)
      .input("start_time", sql.DateTime, toLocalDateTime(data.start_time))
      .input("stop_time", sql.DateTime, toLocalDateTime(data.stop_time)).query(`
        INSERT INTO dailyReport (op_date, machine, operator, job, start_time, stop_time, op_hour)
        VALUES (@op_date, @machine, @operator, @job, @start_time, @stop_time,
        DATEDIFF(MINUTE, @start_time, @stop_time))
      `);

    return { success: true, message: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢" };
  } catch (err) {
    console.error("insert error:", err);
    return { success: false, error: err.message };
  }
});

ipcMain.handle("update-report", async (event, data) => {
  try {
    let pool = await sql.connect(config);
    await pool
      .request()
      .input("op_id", sql.Int, data.op_id)
      .input("op_date", sql.Date, data.op_date)
      .input("machine", sql.VarChar(50), data.machine)
      .input("operator", sql.VarChar(50), data.operator)
      .input("job", sql.VarChar(100), data.job)
      .input("start_time", sql.DateTime, toLocalDateTime(data.start_time))
      .input("stop_time", sql.DateTime, toLocalDateTime(data.stop_time)).query(`
        UPDATE dailyReport
        SET op_date=@op_date, machine=@machine, operator=@operator, job=@job,
            start_time=@start_time, stop_time=@stop_time,
            op_hour = DATEDIFF(MINUTE, @start_time, @stop_time)
        WHERE op_id=@op_id
      `);
    return { success: true, message: "‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢" };
  } catch (err) {
    console.error("update error:", err);
    return { success: false, error: err.message };
  }
});

ipcMain.handle("get-reports", async (event, date) => {
  try {
    let pool = await sql.connect(config);
    let query = "SELECT * FROM dailyReport";
    let request = pool.request();
    if (date) {
      query += " WHERE CAST(op_date AS DATE) = @date";
      request = request.input("date", sql.Date, date);
    }
    query += " ORDER BY op_date DESC";
    let result = await request.query(query);
    return result.recordset;
  } catch (err) {
    console.error("get-reports error:", err);
    return { error: err.message };
  }
});

ipcMain.handle("delete-multiple", async (event, ids) => {
  try {
    if (!ids || ids.length === 0) {
      return { success: false, error: "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö" };
    }
    let pool = await sql.connect(config);
    await pool
      .request()
      .query(`DELETE FROM dailyReport WHERE op_id IN (${ids.join(",")})`);
    return { success: true, message: "‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢" };
  } catch (err) {
    console.error("delete-multiple error:", err);
    return { success: false, error: err.message };
  }
});

ipcMain.handle("export-excel", async (event, date) => {
  try {
    let pool = await sql.connect(config);
    let query = "SELECT * FROM dailyReport";
    let request = pool.request();
    if (date) {
      query += " WHERE CAST(op_date AS DATE) = @date";
      request = request.input("date", sql.Date, date);
    }
    let result = await request.query(query);
    const reports = result.recordset;

    if (!reports || reports.length === 0) {
      return { success: false, error: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" };
    }

    const data = reports.map((r) => ({
      ‡∏•‡∏≥‡∏î‡∏±‡∏ö: r.op_id,
      ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: formatDateUTC(r.op_date),
      ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£: r.machine,
      ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: r.operator,
      ‡∏á‡∏≤‡∏ô: r.job,
      ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: formatDateTimeUTC(r.start_time),
      ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î: formatDateTimeUTC(r.stop_time),
      ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô: formatHourMinute(r.op_hour),
    }));

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Reports");

    const exportPath = path.join(
      app.getPath("documents"),
      `daily_report_${Date.now()}.xlsx`
    );
    XLSX.writeFile(wb, exportPath);

    return { success: true, message: "Export ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", path: exportPath };
  } catch (err) {
    console.error("export-excel error:", err);
    return { success: false, error: err.message };
  }
});

ipcMain.handle("export-pdf", async (event, date) => {
  try {
    let pool = await sql.connect(config);
    let query = "SELECT * FROM dailyReport";
    let request = pool.request();
    if (date) {
      query += " WHERE CAST(op_date AS DATE) = @date";
      request = request.input("date", sql.Date, date);
    }
    query += " ORDER BY op_date DESC";
    let result = await request.query(query);
    const reports = result.recordset;

    if (!reports || reports.length === 0) {
      return { success: false, error: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" };
    }

    const exportPath = path.join(
      app.getPath("documents"),
      `daily_report_${Date.now()}.pdf`
    );
    const doc = new PDFDocument({ margin: 30 });
    doc.pipe(fs.createWriteStream(exportPath));

    doc.registerFont(
      "THSarabunNew",
      path.join(__dirname, "fonts", "THSarabunNew.ttf")
    );
    doc.registerFont(
      "THSarabunNewBold",
      path.join(__dirname, "fonts", "THSarabunNew Bold.ttf")
    );

    doc
      .font("THSarabunNewBold")
      .fontSize(26)
      .text("‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏û‡∏µ.‡∏ã‡∏µ.‡∏õ‡∏¥‡πÇ‡∏ï‡∏£‡πÄ‡∏•‡∏µ‡∏¢‡∏°‡πÅ‡∏≠‡∏ô‡∏î‡πå‡πÄ‡∏ó‡∏≠‡∏£‡πå‡∏°‡∏¥‡∏ô‡∏≠‡∏• ‡∏à‡∏≥‡∏Å‡∏±‡∏î", {
        align: "center",
      });
    doc.moveDown(0.3);
    doc
      .font("THSarabunNew")
      .fontSize(16)
      .text("‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å‡πÄ‡∏ó‡∏Å‡∏≠‡∏á / ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏´‡∏ô‡∏±‡∏Å", { align: "center" });
    doc.moveDown(0.2);
    const reportDate = new Date(reports[0].op_date);
    const thaiMonths = [
      "‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°",
      "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå",
      "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°",
      "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô",
      "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°",
      "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô",
      "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°",
      "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°",
      "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô",
      "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°",
      "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô",
      "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°",
    ];
    const formattedDate = `${reportDate.getDate()} ${thaiMonths[reportDate.getMonth()]} ${reportDate.getFullYear() + 543}`;
    doc
      .font("THSarabunNew")
      .fontSize(16)
      .text(`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formattedDate}`, { align: "center" });
    doc.moveDown(1);

    const headers = [
      "‡∏•‡∏≥‡∏î‡∏±‡∏ö",
      "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà",
      "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£",
      "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô",
      "‡∏á‡∏≤‡∏ô",
      "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô",
      "‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î",
      "‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô",
    ];
    const columnWidths = [40, 65, 60, 150, 200, 100, 100, 60];
    let startX = 30;
    let startY = doc.y + 10;

    headers.forEach((h, i) => {
      doc.rect(startX, startY, columnWidths[i], 30).stroke();
      doc.text(h, startX + 5, startY + 8, {
        width: columnWidths[i] - 10,
        align: "center",
      });
      startX += columnWidths[i];
    });

    let rowY = startY + 30;
    reports.forEach((r, idx) => {
      startX = 30;
      const row = [
        idx + 1,
        formatDateUTC(r.op_date),
        r.machine || "",
        r.operator || "",
        r.job || "",
        formatDateTimeUTC(r.start_time),
        formatDateTimeUTC(r.stop_time),
        formatHourMinute(r.op_hour),
      ];

      row.forEach((cell, i) => {
        doc.rect(startX, rowY, columnWidths[i], 25).stroke();
        doc.text(cell.toString(), startX + 3, rowY + 7, {
          width: columnWidths[i] - 6,
          align: "center",
        });
        startX += columnWidths[i];
      });
      rowY += 25;

      if (rowY > 550) {
        doc.addPage({ size: "A4", layout: "landscape" });
        rowY = 50;
      }
    });

    doc.end();

    return { success: true, message: "Export PDF ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", path: exportPath };
  } catch (err) {
    console.error("export-pdf error:", err);
    return { success: false, error: err.message };
  }
});

// v2.7 preload setup
const { contextBridge, ipcRenderer } = require("electron");

contextBridge.exposeInMainWorld("api", {
  getLists: () => ipcRenderer.invoke("get-lists"),
  saveReport: (data) => ipcRenderer.invoke("insert-report", data),
  updateReport: (data) => ipcRenderer.invoke("update-report", data),
  getReports: (date) => ipcRenderer.invoke("get-reports", date),
  deleteReport: (id) => ipcRenderer.invoke("delete-report", id),
  deleteMultiple: (ids) => ipcRenderer.invoke("delete-multiple", ids),
  exportExcel: (date) => ipcRenderer.invoke("export-excel", date),

  exportPDF: (date) => ipcRenderer.invoke("export-pdf", date), // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° PDF
});

contextBridge.exposeInMainWorld("auth", {
  login: (data) => ipcRenderer.invoke("login-attempt", data),
  addUser: (data) => ipcRenderer.invoke("add-user", data),
});

ipcRenderer.on("login-success", (event, user) => {
  window.dispatchEvent(new CustomEvent("login-success", { detail: user }));
});

contextBridge.exposeInMainWorld("excel", {
  exportTable: (reports, filename) => {
    // ‚úÖ ‡πÉ‡∏ä‡πâ formatDate / formatDateTime
    const data = reports.map((r) => ({
      ‡∏•‡∏≥‡∏î‡∏±‡∏ö: r.op_id,
      ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: formatDate(r.op_date),
      ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£: r.machine,
      ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: r.operator,
      ‡∏á‡∏≤‡∏ô: r.job,
      ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: formatDateTime(r.start_time),
      ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î: formatDateTime(r.stop_time),
      ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô: formatHourMinute(r.op_hour),
    }));

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Reports");
    XLSX.writeFile(wb, filename || "daily_report.xlsx");
  },
});



Delete constrain

‡∏ò‡∏µ‡πÅ‡∏Å‡πâ (‡∏ó‡∏µ‡∏•‡∏∞‡∏Ç‡∏±‡πâ‡∏ô)

‡∏´‡∏≤ constraint ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö time_stamp

SELECT name, object_id
FROM sys.default_constraints
WHERE parent_object_id = OBJECT_ID('dailyReport')
  AND COL_NAME(parent_object_id, parent_column_id) = 'time_stamp';


‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á constraint (‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏Ñ‡∏∏‡∏ì‡∏Å‡πá‡∏Ñ‡∏∑‡∏≠ DF__dailyRepo__time___2739D489)

‡∏•‡∏ö constraint ‡∏Å‡πà‡∏≠‡∏ô

ALTER TABLE dailyReport
DROP CONSTRAINT DF__dailyRepo__time___2739D489;


‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡∏•‡∏ö column

ALTER TABLE dailyReport
DROP COLUMN time_stamp;
