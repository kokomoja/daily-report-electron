<!doctype html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>Daily Report</title>
    <style>
      table {
        border-collapse: collapse;
        width: 100%;
      }
      table,
      th,
      td {
        border: 1px solid black;
      }
      th,
      td {
        text-align: center;
        vertical-align: middle;
        padding: 5px;
      }
      #exportBtn {
        margin-left: 10px;
      }
    </style>
  </head>
  <body>
    <nav style="background: #333; color: #fff; padding: 10px">
      <span style="font-weight: bold">üìë ISO Control</span>
      <button
        id="menuInsertOpreBtn"
        style="
          float: right;
          background: #4caf50;
          color: white;
          border: none;
          padding: 5px 15px;
          cursor: pointer;
        "
      >
        ‚ûï Insert ISO Code
      </button>
    </nav>

    <!-- Modal ‡∏ü‡∏≠‡∏£‡πå‡∏° Insert OPRE -->
    <div
      id="opreModal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        text-align: center;
        padding-top: 100px;
      "
    >
      <div
        style="
          background: #fff;
          display: inline-block;
          padding: 20px;
          border-radius: 8px;
          min-width: 320px;
        "
      >
        <h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ISO Code</h3>

        <label>ISO Code:</label><br />
        <input type="text" id="opre_code" /><br /><br />

        <label>Revision:</label><br />
        <input type="text" id="opre_rev" /><br /><br />

        <label>Effective Date:</label><br />
        <input type="date" id="opre_eff" /><br /><br />

        <button id="saveOpreBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button id="cancelOpreBtn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>

    <h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô ‡∏ù‡πà‡∏≤‡∏¢‡∏õ‡∏é‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏Å‡∏≠‡∏á</h2>
    <p id="welcome"></p>

    <div
      style="
        display: flex;
        align-items: center;
        justify-content: space-between;
        max-width: 600px;
      "
    >
      <div>
        <label>ID:</label>
        <input type="text" id="op_id" disabled />
      </div>
      <div>
        <label>Revision:</label>
        <select id="opre_select" style="min-width: 200px"></select>
      </div>
    </div>
    <br /><br />
    <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
    <input type="date" id="op_date" /><br /><br />

    <label>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£:</label>
    <select id="machine"></select
    ><br /><br />

    <label>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</label>
    <select id="operator"></select
    ><br /><br />

    <label>‡∏á‡∏≤‡∏ô:</label>
    <input type="text" id="job" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥..." /><br /><br />

    <label>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:</label>
    <input type="datetime-local" id="start_time" /><br /><br />

    <label>‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</label>
    <input type="datetime-local" id="stop_time" /><br /><br />

    <button id="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    <button id="clearBtn">‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå</button>
    <button id="exportBtn">Export to Excel</button>
    <button id="exportPdfBtn">Export to PDF</button>

    <p
      id="status"
      style="color: green; font-weight: bold; margin-top: 10px"
    ></p>

    <h3 id="reportTitle">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
    <table id="reportTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
          <th>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</th>
          <th>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
          <th>‡∏á‡∏≤‡∏ô</th>
          <th>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</th>
          <th>‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</th>
          <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
          <th>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó</th>
          <th>‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
          <th>Revision</th>
          <th>
            <button id="deleteBtn" onclick="deleteSelected()">
              ‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            </button>
            <br />
            <input type="checkbox" id="checkAll" /> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
          </th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <script>
      function formatThaiDate(dateStr) {
        if (!dateStr) return "";
        const d = new Date(dateStr);
        const thaiMonths = [
          "‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°",
          "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå",
          "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°",
          "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô",
          "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°",
          "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô",
          "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°",
          "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°",
          "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô",
          "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°",
          "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô",
          "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°",
        ];
        const day = d.getDate();
        const month = thaiMonths[d.getMonth()];
        const year = d.getFullYear() + 543; // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡∏û.‡∏®.
        return `${day} ${month} ${year}`;
      }

      function updateReportTitle() {
        const selectedDate = document.getElementById("op_date").value;
        const title = selectedDate
          ? `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatThaiDate(selectedDate)}`
          : "‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";
        document.getElementById("reportTitle").textContent = title;
      }

      function formatDate(dateValue) {
        if (!dateValue) return "";
        if (dateValue instanceof Date) {
          const yyyy = dateValue.getUTCFullYear();
          const mm = String(dateValue.getUTCMonth() + 1).padStart(2, "0");
          const dd = String(dateValue.getUTCDate()).padStart(2, "0");
          return `${yyyy}-${mm}-${dd}`;
        }
        return dateValue.toString().slice(0, 10);
      }

      function formatDateTime(dateValue) {
        if (!dateValue) return "";
        if (dateValue instanceof Date) {
          const yyyy = dateValue.getUTCFullYear();
          const mm = String(dateValue.getUTCMonth() + 1).padStart(2, "0");
          const dd = String(dateValue.getUTCDate()).padStart(2, "0");
          const hh = String(dateValue.getUTCHours()).padStart(2, "0");
          const min = String(dateValue.getUTCMinutes()).padStart(2, "0");
          return `${yyyy}-${mm}-${dd} ${hh}:${min}`;
        }
        return dateValue.toString().replace("T", " ").slice(0, 16);
      }

      function formatHourMinute(totalMinutes) {
        if (totalMinutes == null) return "";
        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;
        return `${hours.toString().padStart(2, "0")}:${minutes
          .toString()
          .padStart(2, "0")}`;
      }

      function getDefaultDateTime(hour, minute) {
        const now = new Date();
        now.setHours(hour, minute, 0, 0);
        return now.toISOString().slice(0, 16);
      }

      // ‚úÖ clear form (reset ‡∏Ñ‡πà‡∏≤ default)
      function clearForm() {
        const today = document.getElementById("op_date").value;
        document.getElementById("op_id").value = "";
        document.getElementById("machine").value = "";
        document.getElementById("operator").value = "";
        document.getElementById("job").value = "";
        document.getElementById("start_time").value = `${today}T08:00`;
        document.getElementById("stop_time").value = `${today}T17:00`;
        document.getElementById("submit").textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å";
      }

      // ======================= Load Lists =======================
      async function loadLists() {
        const lists = await window.api.getLists();
        const machineSelect = document.getElementById("machine");
        const operatorSelect = document.getElementById("operator");

        machineSelect.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ --</option>`;
        operatorSelect.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô --</option>`;

        if (lists.machines) {
          // ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô
          lists.machines
            .sort((a, b) => a.localeCompare(b, "th")) // th ‚Üí ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏ö‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏î‡πâ‡∏ß‡∏¢
            .forEach(
              (m) =>
                (machineSelect.innerHTML += `<option value="${m}">${m}</option>`)
            );
        }

        if (lists.operators) {
          // ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô
          lists.operators
            .sort((a, b) => a.localeCompare(b, "th"))
            .forEach(
              (o) =>
                (operatorSelect.innerHTML += `<option value="${o}">${o}</option>`)
            );
        }
      }

      // ======================= Load OPRE List =======================

      async function loadOpreList() {
        const list = await window.opre.getList();
        const select = document.getElementById("opre_select");
        select.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Revision --</option>`;

        if (list && !list.error) {
          list.forEach((item) => {
            // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á opre_show
            select.innerHTML += `<option value="${item.opre_id}">${item.opre_show}</option>`;
          });
        }
      }

      // ======================= Load Reports =======================
      async function loadReports() {
        const selectedDate = document.getElementById("op_date").value;
        const reports = await window.api.getReports(selectedDate);
        const tbody = document.querySelector("#reportTable tbody");
        tbody.innerHTML = "";

        if (reports && !reports.error) {
          reports.forEach((r) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                    <td>${r.op_id}</td>
                    <td>${formatDate(r.op_date)}</td>
                    <td>${r.machine || ""}</td>
                    <td>${r.operator || ""}</td>
                    <td>${r.job || ""}</td>
                    <td>${formatDateTime(r.start_time)}</td>
                    <td>${formatDateTime(r.stop_time)}</td>
                    <td>${formatHourMinute(r.op_hour)}</td>
                    <td>${formatDateTime(r.time_stamp)}</td>
                    <td>${r.recorder_name || ""}</td>
                     <td>${r.opre_show || ""}</td>
                    <td><input type="checkbox" class="rowCheck" value="${r.op_id}"></td>
                  `;
            tr.addEventListener("click", () => {
              document.getElementById("op_id").value = r.op_id;
              document.getElementById("op_date").value = formatDate(r.op_date);
              document.getElementById("machine").value = r.machine || "";
              document.getElementById("operator").value = r.operator || "";
              document.getElementById("job").value = r.job || "";
              if (r.start_time)
                document.getElementById("start_time").value = new Date(
                  r.start_time
                )
                  .toISOString()
                  .slice(0, 16);
              if (r.stop_time)
                document.getElementById("stop_time").value = new Date(
                  r.stop_time
                )
                  .toISOString()
                  .slice(0, 16);

              if (r.opre_rev) {
                const select = document.getElementById("opre_select");
                // ‡∏ß‡∏ô‡∏´‡∏≤ option ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ opre_rev ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏±‡∏ô
                for (let option of select.options) {
                  if (
                    option.text === r.opre_show ||
                    option.text.includes(r.opre_rev)
                  ) {
                    select.value = option.value;
                    break;
                  }
                }
              }

              document.getElementById("submit").textContent = "‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó";
            });
            tbody.appendChild(tr);
          });
        }

        document
          .getElementById("checkAll")
          .addEventListener("change", function () {
            document
              .querySelectorAll(".rowCheck")
              .forEach((cb) => (cb.checked = this.checked));
          });
      }

      // ======================= Delete =======================
      async function deleteSelected() {
        const checked = Array.from(
          document.querySelectorAll(".rowCheck:checked")
        ).map((cb) => parseInt(cb.value));
        if (checked.length === 0) {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö");
          return;
        }
        if (checked.length === 0) {
          document.getElementById("status").textContent =
            "‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö";
          return;
        }

        const res = await window.api.deleteMultiple(checked);
        document.getElementById("status").textContent =
          res.message || res.error;
        await loadReports();
        loadOpreList();
        clearForm();
      }

      // ======================= Export =======================
      async function exportExcel() {
        const selectedDate = document.getElementById("op_date").value;
        const res = await window.api.exportExcel(selectedDate);
        if (res.success) alert("‚úÖ " + res.message + "\n‡πÑ‡∏ü‡∏•‡πå: " + res.path);
        else alert("‚ùå Export ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: " + res.error);
      }

      async function exportPDF() {
        const selectedDate = document.getElementById("op_date").value;
        const res = await window.api.exportPDF(selectedDate);
        if (res.success) alert("‚úÖ " + res.message + "\n‡πÑ‡∏ü‡∏•‡πå: " + res.path);
        else alert("‚ùå Export PDF ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: " + res.error);
      }

      // ======================= Init =======================
      window.addEventListener("DOMContentLoaded", () => {
        document.getElementById("op_date").value = new Date()
          .toISOString()
          .split("T")[0];
        updateReportTitle();
        document.getElementById("start_time").value = getDefaultDateTime(8, 0);
        document.getElementById("stop_time").value = getDefaultDateTime(17, 0);

        document;
        const username = localStorage.getItem("username") || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠";
        document.getElementById("welcome").textContent =
          "üëã ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì " + username;

        document
          .getElementById("submit")
          .addEventListener("click", async () => {
            const data = {
              op_id: document.getElementById("op_id").value || null,
              op_date: document.getElementById("op_date").value,
              machine: document.getElementById("machine").value,
              operator: document.getElementById("operator").value,
              job: document.getElementById("job").value,
              start_time: document.getElementById("start_time").value,
              stop_time: document.getElementById("stop_time").value,
              recorder_name: localStorage.getItem("username") || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏",
              opre_id: document.getElementById("opre_select").value || null, // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
            };

            let res;
            if (data.op_id) res = await window.api.updateReport(data);
            else res = await window.api.saveReport(data);

            document.getElementById("status").textContent =
              res.message || res.error;

            await loadReports();
            loadOpreList();
            clearForm();
          });

        document.getElementById("op_date").addEventListener("change", () => {
          updateReportTitle();
          clearForm();
          loadReports();
          loadOpreList();
        });

        document
          .getElementById("clearBtn")
          .addEventListener("click", () => clearForm());

        document
          .getElementById("exportBtn")
          .addEventListener("click", exportExcel);
        document
          .getElementById("exportPdfBtn")
          .addEventListener("click", exportPDF);

        loadLists();
        loadReports();
        loadOpreList();
      });

      // ======================= OPRE Modal =======================
      document
        .getElementById("menuInsertOpreBtn")
        .addEventListener("click", () => {
          document.getElementById("opreModal").style.display = "block";
        });

      document.getElementById("cancelOpreBtn").addEventListener("click", () => {
        document.getElementById("opreModal").style.display = "none";
      });

      document
        .getElementById("saveOpreBtn")
        .addEventListener("click", async () => {
          const opre_code = document.getElementById("opre_code").value.trim();
          const opre_rev = document.getElementById("opre_rev").value.trim();
          const opre_eff = document.getElementById("opre_eff").value;

          if (!opre_code || !opre_rev || !opre_eff) {
            alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
            return;
          }

          const res = await window.opre.insert({
            opre_code,
            opre_rev,
            opre_eff,
          });

          if (res.success) {
            alert("‚úÖ " + res.message);
            // reset
            document.getElementById("opre_code").value = "";
            document.getElementById("opre_rev").value = "";
            document.getElementById("opre_eff").value = "";
            document.getElementById("opreModal").style.display = "none";
          } else {
            alert("‚ùå " + (res.error || "Insert ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß"));
          }
        });

      window.addEventListener("login-success", (e) => {
        const user = e.detail;
        document.getElementById("welcome").textContent =
          "üëã ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì " + user.username;
      });
    </script>
  </body>
</html>
